upstream wsgi_api_mgmt {
  # fail_timeout=0 means we always retry an upstream even if it failed
  # to return a good HTTP response (in case the gunicorn master nukes a
  # single worker for timing out).

  server django:8080 fail_timeout=0;
}
server {
    listen              80;
    server_name         api_mgmt;

    client_max_body_size 4G;
    keepalive_timeout 5;
    location /media/  {
        alias /var/nginx/media/;
        expires 30d;
    }
    location /static/  {
        alias /var/nginx/static/;
        expires 30d;
    }

    location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Protocol https;
        proxy_redirect off;

        if (!-f $request_filename) {
            rewrite ^/mgmt(.*)$ $1 last;
            proxy_pass http://wsgi_api_mgmt;
            break;
        }
    }
    gzip on;
    gzip_disable "msie6";
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

}
