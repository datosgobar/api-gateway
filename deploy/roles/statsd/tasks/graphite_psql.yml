---

#Taken from: https://github.com/ansible/ansible-examples/blob/master/language_features/postgresql.yml
- name: Ensure database is created
  postgresql_db:
    name: "{{ graphite_database_name }}"
    encoding: UTF-8
    lc_collate: en_US.UTF-8
    lc_ctype: en_US.UTF-8
    template: template0
  become: yes
  become_user: postgres
  vars:
    ansible_ssh_pipelining: true

- name: Ensure user has access to database
  postgresql_user:
    db: "{{ graphite_database_name }}"
    name: "{{ graphite_database_user }}"
    password: "{{ graphite_database_password }}"
    priv: ALL
  become: yes
  become_user: postgres
  vars:
    ansible_ssh_pipelining: true

- name: Ensure user does not have unnecessary privilege
  postgresql_user:
    name: "{{ graphite_database_user }}"
    role_attr_flags: NOSUPERUSER,NOCREATEDB
  become: yes
  become_user: postgres
  vars:
    ansible_ssh_pipelining: true

- name: Ensure no other user can access the database
  postgresql_privs:
    db: "{{ graphite_database_name }}"
    role: PUBLIC
    type: database
    priv: ALL
    state: absent
  become: yes
  become_user: postgres
  vars:
    ansible_ssh_pipelining: true
